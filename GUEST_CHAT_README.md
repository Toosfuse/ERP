# راهنمای پیادهسازی سیستم چت مهمان

## مراحل نصب و راهاندازی:

### 1. اجرای Migration در دیتابیس
```sql
-- فایل Migrations/GuestChatTables.sql را در SQL Server اجرا کنید
```

### 2. پیکربندی سرویس SMS
فایل `Services/SmsService.cs` را ویرایش کنید و API Key سرویس SMS خود را وارد کنید:

```csharp
// مثال برای کاوهنگار:
var client = new KavenegarApi("YOUR_API_KEY");
await client.Send(phoneNumber, $"کد تایید: {code}");

// مثال برای ملیپیامک:
// var sms = new RestClient("https://rest.payamak-panel.com/api/SendSMS/SendSMS");
```

### 3. مسیرهای دسترسی:

#### برای مهمانان:
- **ورود مهمان**: `/Chat/GuestLogin`
- **صفحه چت**: `/Chat/Index` (بعد از احراز هویت)

#### برای ادمین:
- **مدیریت مهمانان**: `/GuestChatManagement/Index`

### 4. فلوی کاری:

#### ورود مهمان:
1. مهمان وارد `/Chat/GuestLogin` میشود
2. شماره موبایل خود را وارد میکند
3. کد 5 رقمی SMS دریافت میکند (اعتبار 5 دقیقه)
4. کد را وارد میکند و نام خود را مینویسد
5. وارد صفحه چت میشود
6. فقط با کاربرانی که Admin تعیین کرده چت میکند
7. دسترسی بعد از 2 ساعت منقضی میشود

#### مدیریت توسط Admin:
1. Admin وارد `/GuestChatManagement/Index` میشود
2. لیست مهمانان فعال را میبیند
3. برای هر مهمان میتواند:
   - کاربران مجاز برای چت را تعیین کند
   - دسترسی را تمدید کند (افزودن ساعت)
   - مهمان را غیرفعال کند

### 5. امنیت:

- کدهای تایید بعد از 5 دقیقه منقضی میشوند
- حداکثر 3 تلاش برای وارد کردن کد
- دسترسی مهمان محدود به 2 ساعت (قابل تمدید توسط Admin)
- مهمان فقط با کاربران تعیین شده میتواند چت کند
- تمام پیامها Sanitize میشوند (XSS Prevention)
- Cookie های مهمان HttpOnly هستند

### 6. محدودیتهای مهمان:

- نمیتواند پیام را ویرایش کند
- نمیتواند پیام را فوروارد کند
- نمیتواند چت را حذف کند
- محدودیت آپلود فایل (همان محدودیتهای کاربران عادی)

### 7. نکات مهم:

- قبل از استفاده در Production، حتماً سرویس SMS واقعی را پیکربندی کنید
- برای تست، کدهای SMS در Console نمایش داده میشوند
- جداول Guest از جداول User کاملاً جدا هستند
- پیامهای مهمان در جدول `GuestChatMessages` ذخیره میشوند

### 8. تنظیمات اضافی (اختیاری):

#### تغییر مدت زمان اعتبار:
در `ChatController.cs` خط 95:
```csharp
ExpiryDate = DateTime.Now.AddHours(2) // تغییر به مدت دلخواه
```

#### تغییر مدت اعتبار کد SMS:
در `ChatController.cs` خط 73:
```csharp
ExpiryDate = DateTime.Now.AddMinutes(5) // تغییر به مدت دلخواه
```

### 9. نمونه استفاده:

```
مهمان → 09123456789 → کد: 12345 → نام: علی احمدی → چت با کارشناس پشتیبانی
```

### 10. Troubleshooting:

**مشکل: کد SMS ارسال نمیشود**
- بررسی کنید سرویس SMS پیکربندی شده باشد
- در حالت Development، کد در Console نمایش داده میشود

**مشکل: مهمان نمیتواند با کاربر چت کند**
- Admin باید دسترسی را از `/GuestChatManagement/Index` تعیین کند

**مشکل: دسترسی منقضی شده**
- Admin میتواند از بخش مدیریت، دسترسی را تمدید کند

## پشتیبانی:
برای سوالات بیشتر به مستندات ASP.NET Core Identity و SignalR مراجعه کنید.
